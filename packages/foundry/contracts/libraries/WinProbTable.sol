// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

/// @notice Effective score win probability lookup table (4 lanes).
/// @dev Index order is all sorted tuples (a<=b<=c<=d) with a,b,c,d in [1..10], in nested-loop order.
/// Each entry is 8 bytes: 4x uint16 (basis points) in big-endian.
/// @dev This is a deployable contract (not a library) so `GiraffeRace` doesn't exceed the 24KB size limit.
contract WinProbTable {
    uint256 internal constant ENTRY_BYTES = 8;
    uint256 internal constant TABLE_LEN = 715;

    bytes internal constant TABLE = hex"09d409d909bf09a40959095d09460b1408c908d908c40cab0846084a08360e4a07af07b007a5100c071c071e071211c306860681067c138d05ec05f305ea154705680568055516eb04c404e804d1189308e008ec0ab10a93085b086e0a270c1f07e207e909890dbb0758075608ef0f7306cd06cd085211240641063a07ac12ea05ad05b6070514a8053005330663164a049a04b305c617fd07ed07f10ba30b8f077e07750b000d1d06ff06f00a590ec8067e067309a1107e05f605eb08fc1233056e0570083b13f704f504f5078b159b046a047a06d91753071107070c850c72069a068d0bd80e100621061a0b150fc005a4059a0a56117c05280529098d133304b504b408d114d60434044308031695062f06200d6f0d5205c005b90ca60ef1054905410bdf10a704d704d80b0812580471046d0a31140203fe0407094015cb055a055a0e3e0e1e04f004ed0d680fcb0488048e0c80117b042a042a0b9b132103c203c90a9714ef049204950efe0eeb0435043d0e11108d03e203e10d1e1230038703890c0413fb03e303f30fa70f93039b039e0eaa112d034a034b0d71130a0357034f104510240306030b0f0511fa02c202be10c910c708780a3d0a3c0a1e07fd09bc09bb0b9c078c092d09250d330709089808910ede068707fb07fe10910600075b07601255057206bf06c2141d04fd062e062915bc046f059f058f1774079709460b1f0b14072f08be0a860c9d06b8083309e90e3c063e07a3093d0ff205bc070c08a111a70539067407ee137504c805ee074715140441055f069c16d406ca08410c0c0bfa065a07be0b690d8f05e7073a0ab00f3e056f06ab09fa10fc04f70623093d12ba048b05a508891458040e051d07c7161e05f407480cfa0cdb058b06cd0c3e0e7b051906450b81103104ab05c80ab211ea044b055409e4138e03db04de08fe1559052b065e0dd40db304c405e10d0a0f60046005700c2b1115040805050b4e12b5039f049c0a501485046a057d0e9e0e8b041105150dbb102f03c204b10cd011cd036804510bb9139e03c104bf0f520f3e037d04640e5d10d1032d04000d2c12b7033d040b0ff50fd302eb03b90ebd11af02af035c1089107b072c0ab50a9c0a9306cb0a2d0a0c0c0c065c0991097a0da905ea08ff08d80f4f057208500845110904fb07a0079d12d90493070b06ff14730414066b06591637066e09ac0b820b740605091b0aea0d07059908920a3d0ea8052b07ee0990106604be074908e11228045a06bf083513c103e506200780158c05a408950c7a0c5d054208170bc90dee04d9077d0b160fa5047606e20a531166041c06620991130003b405d708b414d004e907950d5e0d34048b07080c9f0edf042f067b0bcb109b03de06050afb1232037c05880a051407043606970e310e1303e406150d590fbd039c05aa0c741156034905370b65132b039c05ac0ef00ed8035d05480e061065031104df0cd1124e032104e80f950f7202d204850e691150029b042d102a101f060d0b210afa0ae905ab0a8a0a6b0c71054709ff09c80e0204e0094b09270fbe047b08940884117d041e07e407e5132903bb0734073214ef05510a040be80bd204f509830b430d55049308d80a9a0f0b0438082d09e210c903e5078d092c1273039006df0863143e04a408f60ccf0ca7044d08550c1e0e5003f807b90b57100903ab07240a9111af0359069209a8137d03ff07cd0db20d9203b307400ce50f38036e06b70c0e10dd032a06300b0b12ab037106c80e790e5e0335064b0d990ff702f605d20c7111d702fd05d50f300f0e02ba056c0e0710e3028105120fc20fbc05010b750b570b4304ad0aeb0abb0cbd04530a3c0a1e0e6403ff09850973101903b008d408c811c4035e0812080a139604610a510c440c1a041109ae0b9c0db403c209030ae40f66037b085f0a29110d032c07bc094a12de03ca091e0d240d04038508800c660ea5034407e90b9d1046030007590aa01217034607f90df60dda030e076f0d250f6e02d006eb0c09114d02d906f50eb20e910299067c0d951065026806040f550f5004240bb90ba30b9003db0b150b050d1b03930a630a590ec2035009b309ae1060030408fa08e6122c039a0a790c880c76035909d20bd90e0c031d09330b1d0fa302d9088c0a3b11700320093d0d640d4f02eb08a80ca20edb02ae08180b9910b202b7081f0e310e09027b079e0d1c0fdb024b07160ed70ed803610be90be70bdf03280b400b450d6202ef0a980a950ef502b209d409c610c402f40aa00cc70cb502c10a040c110e39028a09540b201012029109700d9d0d73025c08d70c950f48022608420e520e5602c40c150c1d0c1a02950b750b730d93025f0abd0a9a0f5a02680ace0d020cd802360a310c0c0e9e020609910dbb0dbf023e0c440c4f0c3f02170b9c0b710deb01e60af60d160d1e01c40c7c0c670c69099609d709e009c2091d096009600b34089a08d208c90cdb0808084a083d0e81077c07b607be102006f1071e072911d7065c06900698138c05d005f90606154105450566057016f508a708e20add0aaa082f08630a3f0c3f07a907e4099a0de80725075a090a0f8706a406ce086511390619064507c112f1059305bb071914a9051005340678165407bc07f70bbc0ba20741077e0b180d3906c706fe0a710eda064d067b09b9108e05d005f8090c123c05510577085013f904d304f707aa159c06da070a0ca40c87066b06920bf70e1d05fa061a0b3a0fc2058405a00a7811730511052a09ad1327049004ba08f314d3060606280d7c0d6605a005bb0cb40f010532054c0be810a904c904dd0b161254045104770a481400053e05590e530e2604d904f20d760fcf047c048f0c921172040f04300bb11321048d04980f090ee20437043c0e1a108403c303e90d32123203ec03f00fa50f90038003a10ebe1131034e03511049102708400a470a600a2907d009c309cc0bb10753093309340d5606d7089c08ae0eef065c07fa081110a905d6076107781261055a06c906d9141404e00635064115ba076309480b440b2106f008c50aa90cb1067e08390a0d0e4c060a07a1095e10070591070f08ba11b6051906800809136d04a705f7076915090692084b0c2c0c08062807c70b870d9b05bc07390ad50f45054b06b30a1b10f704e00631095912a6046705b308ae144805ca07580d000ced056906d50c420e9004fe065b0b831034049c05e00abc11d8042b05650a001380050a06600de40dc104a905f20d100f66045205880c36110003ec05140b6812a9045e05870ea60e84040e05250dc2101b03a504c50ce511c203c504cc0f4c0f33036504740e6c10cc033504120ff60fd407030ab90ab90a9b06980a300a2b0c1d06300995099c0db005c508f308f70f610552084d085c111504e407a507b712d10471070e0722146f063f09a60ba80b8305df09170b0f0d0a057c087e0a6b0eac051007e509ba106104ad074b09041214043506bf086513b8058808990c870c68052e080d0bd30e0204c807800b200fa8046e06ef0a62115003fc066809b212fa04d707930d680d3d0479070f0ca30ee50429068e0bd5108403c206120b0e122e043306990e350e0e03e906220d5b0faa038005b30c8e114f03a505b80ee60ecd0343055b0e0e1064031a04e80f9b0f7305e80b150b160afd058f0a870a8b0c70053109e109f00e0d04ce0942094a0fb60475088f08a2116a040107e908121314053e09fb0bfe0bd904e909620b580d6d048c08cd0aaf0f08043b082809fb10b203cc0795094b1264049908e00ce30cb3044208540c280e5203f907be0b670ff30395072f0aa811a4040107d20db40d8903be07460ce80f24035706c30c2510d2037f06d30e6c0e52031d06550dac0ff302f605eb0f2c0f0204fb0b610b6e0b4604ac0ac60ad50cc904540a230a370e63040a096609901010039d08c408ec11c3045f0a370c580c21040d09a00bab0db803cb08f00af60f5f036c085b0a3b110e03d009130d2f0cfe039408700c740e98033007e90bb01047035807ef0df40dd502fa07720d320f7202d806ff0eb30e8604220ba30bbe0b8d03d50b050b200d1503990a510a7a0ead033b09ae09ca105d039c0a700c990c6a036509c50bed0df9030409340b320fa6032e093a0d660d4102d108ae0cb30edf02b708330e2c0df903600be80bf30bd5032f0b440b540d4902d40a850ab40f0402fb0aa60cd00ca002a609ff0c220e49028d09730da30d6d02c60c1f0c2a0c0002780b660b930d9f02640aca0d0e0cd4022f0c360c580c5309a109ce09c409dc092a094509440b5e08a208ca08c50cde0817084a08350e7b078607b807aa102906f80720072511d3067206880693138305f405fd05f5152a08be08c80ab60ad4084108590a270c4f07bd07e4098e0de20737075c08f00f8d06b706cd084e113e0638063c07bb12e105b505c0070f148c07cf07e50ba10bbb0754077c0afe0d4106d906fc0a530ee80662067709a7109005eb05f008fb123905710580084313db06eb07170c730c9a067a06a00bbd0e39060b06230b030fdf059d05a70a471185052e053909821327061106330d540d7805ab05c10c8d0f17054605510bb210c804e004e80af41254055105600e280e3704f504fa0d3f0fe30495049b0c6a11760499049f0ed90efe0448044b0df71086040603fb0f8c0f8308510a390a370a4f07df09b909b10bc70764093209230d5706e7089b08920efb066f080207f910a605f8076b076e123f057e06cf06cc13f7077509440b1b0b3b070308c70a840cc20690083b09e40e60062007aa0943100305b2071a08a411a0053e068807fb134f069f084e0bfd0c25063607ce0b510dbc05cd07470aa20f5a056706c109f110f704fe063d093312a205d2075b0cdd0d06057406df0c220e9b051506660b53104104b305e30aa111d90520066f0db80dc904ca06050cd90f68046c058e0c121104047305940e780e91042305320d9c101f03e304dc0f330f1e071b0aa60a9d0ab106b10a1f0a100c3006440980097b0dd005da08dd08e30f76057308430850110a050407b907a912aa065409a30b7d0b9c05ef090d0add0d36058d08770a380ed4052c07e80990106b04c9076508dd1205059508930c5c0c8c053a08050bb10e2004e107840aeb0fc0048207070a41114604ea078e0d3d0d5b049a07190c6c0ef1043e06a20bb4107c044706aa0dfc0e2303f8063f0d370fa203be05d80ecd0ead05fd0b100af10b1305a10a720a5f0c9f054409d309c40e3504ec092a09270fd30490089908821165054c09eb0bda0bff04f709560b390d8b04a608bb0a7e0f31044d083409df10af04ad08d50cba0cd3046308480bf70e6f040e07c50b4e0ff0041607ca0d830dad03cc07530cd10f20038e06ec0e5e0e3705040b550b490b6e04b50ab40ab60cf2046d0a110a060e8c041209860974100404720a2e0c2a0c47042f09970b760dd403d809110ad70f5003e809110cf90d1e039b08920c570e8c036308160ddb0dbc042a0ba60b970baa03ee0b020aee0d3203a20a610a5d0eaf03ae0a6a0c710c88036909dd0bd20df8033b095b0d460d3403750bde0bd20beb03310b390b4a0d5c030b0ab60cb00c9f02bc0c0c0c0d0c3b09c009a909bd09ea09470932094a0b4e08cd08ae08ca0ccc0846082c083a0e6307b0079e07ab101807140719072011c3069a068c0692135808d808c50aa30ad00865084a0a260c3b07e707d3098b0dcb0759074b08f80f7406c706cd08541129064e064a07c312b407fd07de0b820bb2078b07700ae80d2d070606f10a510ec8067e067a099e107b05ff060109001210071f06ff0c6a0c8806a7068c0bc00e1d062b061d0b060fc305b005b40a5a1152064006280d400d6805cf05c10c800eff0561055c0bca1088056d05610e100e32050d05060d490fb404ad04a90ecf0eeb086d0a220a2a0a570801099f09b70bb9078b091b09260d4407070882089c0eeb067e07f807ff109b0611076c077c121607a009210b150b3a073408a70a850cb006b9081809f70e4806380797094b0ff505c6071e08b2117b06d008360bf30c17066207b30b520da905ed073a0aa30f46057b06c60a0710c80602073e0cd20cff059706d10c1b0e8e053006650b70100a053906660da40dcd04e206000cee0f40048205a90e620e8307400a850a900abc06dc09fa0a090c310668096a09830dbb05f208db08e20f6105860851085510e5067e09780b780ba2061608f30ae10d2705aa086f0a3b0ebb054107ea09a8103c05bd086c0c5e0c88055a07f90baf0e0e04f9077d0b0e0f8b050207820d330d5904b0071a0c790ecd045206b60df30e15061f0af10aea0b1605bf0a5f0a600c92055909d709c50e1c04fc093609410f9d056d09d30bd10bff051009570b2c0d7d04ba08c40a9b0ef804c008d20cab0cd20475084f0c050e48042107da0d790d9b051d0b440b420b6c04c70ab40aa80ced047b0a240a1b0e55047f0a2e0c170c4d043c09a10b810db203ee09160cf60d15043e0b910b8b0bb604000af50afc0d1f03b50a710c620c8803700bbe0bfe0be509dd09d509c2099b0961096709440b0408d508dc08c70c9808540847083c0e3807c507b507b00fe607050725071711cf08ed08ee0ab10a84086a086f0a290c0e07f607e209940da3076e075b08f50f5206bb06dd0841113607fd07f90b9b0b7f079307780afe0d07071506fb0a590ea70666068a0993108d0724070b0c800c6206af06970bd50df50610062c0af70fdd064806310d5e0d3905b805d30c700f16056005730e150e2908840a450a310a17080b09c109b10b9307a0092e09240d1e0721089808940ec4067c080307f010a107a709420b1c0b0c074508b70a890c8a06ce083109f00e21062c07a5093f100106de083a0c0a0bef067007bb0b6a0d7b05dc07440a970f59061007470cf10cc8058806dd0c0c0e9f053306780da80dbe07400aa30a9a0a9306e80a180a120bff0679098609820d8f05e208e808d80f6e0688098f0b880b71062109090af40cf2059708790a2f0ed105c7088c0c740c490548080f0b970e2104fa078d0d390d5006300af60afb0aef05ce0a6e0a700c64054e09d409bd0e31057c09df0bf10bc40504095d0b220d8d04c208cc0cb40cce052f0b4d0b560b3e04bf0ac40a9d0cf004850a280c250c3e04450ba10b900b9a099609e609e009b3091c0968096a0b22089d08df08ea0caa081b084308600e52079307ae07d10ffe08a408f80ad80a9c083008770a4b0c1f07b507e509b40dc2073a075d09110f6707c308030bc20b870751077a0b270d1e06da06ff0a740ec306ed070b0ca10c77067d06990bed0e0d0629063e0d6f0d3b08410a500a5c0a2407d409c909dc0b98075e093309510d2e06ea089c08b90ed10770094f0b450b0d070108c00ab60c980690083a0a0d0e3906a4084c0c250bfb063907c90b800d8e05e6076c0cfe0cc1070e0ab90aba0a8f06a80a2e0a380c02063f097e09a60dad065309a80ba40b7105ec090e0b090d0d05a708980c880c4906000b140b130ae905a40a630a910c78055e09e40c070bc7051f0b430b590b5409a109d009bd09e20924094f09480b55089d08d108b80cea0836085a083c0e4408b808e20aac0acb083a086d0a160c5207d607fb09900db007c608010b8b0bbd076f07930b000d0e071d071c0c7d0c5a08510a400a330a4b07dd09bd09a50bd10785093809290d2a077109410b190b45072508c80a910c9206d208560c020be6071a0a9f0a970ac006ca0a130a210c120681099e0b870b6a06050af30af30b2509c709b409c209d4094f094209460b3908c708da08c40cac08e208d80aa10ab6085f086e0a1e0c2507e407fb0b8d0ba508770a270a310a4107f809ba09b10bad078809470b120b2e072a0a810abb0aaa09e909bb09ca09a30936095c09360b4808c708e10aab0abd087f0a340a3a0a2209b609d409e509a0";

    function _indexSorted(uint8 a, uint8 b, uint8 c, uint8 d) internal pure returns (uint256 idx) {
        // Rank in nested-loop order without brute-forcing all 715 entries.
        // Count of nondecreasing length-r sequences from [s..10] is C((10-s+1)+r-1, r).
        if (a < 1 || d > 10) revert("WinProbTable: bad tuple");
        if (a > b || b > c || c > d) revert("WinProbTable: bad tuple");

        for (uint8 i = 1; i < a; i++) {
            idx += _c3(uint8(13 - i)); // C((10-i)+3,3) = C(13-i,3)
        }
        for (uint8 j = a; j < b; j++) {
            idx += _c2(uint8(12 - j)); // C(12-j,2)
        }
        for (uint8 k = b; k < c; k++) {
            idx += uint256(11 - k); // C(11-k,1)
        }
        idx += uint256(d - c); // C(_,0)
    }

    function _c2(uint8 n) private pure returns (uint256) {
        if (n < 2) return 0;
        return (uint256(n) * uint256(n - 1)) / 2;
    }

    function _c3(uint8 n) private pure returns (uint256) {
        if (n < 3) return 0;
        return (uint256(n) * uint256(n - 1) * uint256(n - 2)) / 6;
    }

    function getSorted(uint8 a, uint8 b, uint8 c, uint8 d) external pure returns (uint16[4] memory probsBps) {
        uint256 idx = _indexSorted(a, b, c, d);
        uint256 off = idx * ENTRY_BYTES;
        probsBps[0] = _u16be(off);
        probsBps[1] = _u16be(off + 2);
        probsBps[2] = _u16be(off + 4);
        probsBps[3] = _u16be(off + 6);
    }

    function _u16be(uint256 off) private pure returns (uint16 v) {
        // TABLE is a constant bytes, so bounds are guaranteed by construction.
        uint8 hi = uint8(TABLE[off]);
        uint8 lo = uint8(TABLE[off + 1]);
        v = (uint16(hi) << 8) | uint16(lo);
    }
}
